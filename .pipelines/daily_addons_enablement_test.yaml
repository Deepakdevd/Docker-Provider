jobs:
    - job: test
      variables:
        armServiceConnectionName: 'ci-1es-acr-connection'
        subscription: '9b96ebbd-c57a-42d1-bbe9-b69296e4c7fb'
      pool:
        name: Azure-Pipelines-CI-Test-EO
      steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: '${{ variables.armServiceConnectionName }}'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az --version
                az account show
                az account set -s ${{ variables.subscription }}
                
                # Define the resource group and AKS cluster name
                resourceGroup="ci-logs-prod-aks"
                aksClusterName="daily_enable_disable_test"
                logAnalyticsWorkspace="/subscriptions/9b96ebbd-c57a-42d1-bbe9-b69296e4c7fb/resourcegroups/ci-logs-prod-aks/providers/microsoft.operationalinsights/workspaces/daily-enable-disable-test-la"
                workspaceId="0b525f9a-755c-4a1a-b6fe-f96a23ea8a4e"

                # Check if the omsagent addon is enabled
                addonEnabled=$(az aks show --resource-group $resourceGroup --name $aksClusterName --query addonProfiles.omsagent.enabled -o tsv)
                
                if [ "$addonEnabled" == "true" ]; then
                    echo "OMSAgent addon is enabled on the AKS cluster."
                    az aks disable-addons --addons monitoring --name $aksClusterName --resource-group $resourceGroup
                    sleep 10
                    echo "Re-enabling the OMSAgent addon..."
                    az aks enable-addons --addons monitoring --name $aksClusterName --resource-group $resourceGroup --workspace-resource-id $logAnalyticsWorkspace
                    echo "OMSAgent addon has been re-enabled."

                    echo "Sleeping 10minutes for everything to get set up and logs start flowing"
                    sleep 400
                    # Check if there is data in the Log Analytics workspace
                    dataCount=$(az monitor log-analytics query --workspace $workspaceId --analytics-query "ContainerInventory | where TimeGenerated > ago(5m) | count" -o tsv)

                    if [ $dataCount -gt 0 ]; then
                      echo "Data is present in the Log Analytics workspace."
                    else
                      echo "No data is present in the Log Analytics workspace."
                      exit -1
                    fi
                else
                    echo "OMSAgent addon is not enabled on the AKS cluster."
                    exit -1
                fi